version: 0.1
component: build
timeoutInSeconds: 6000
runAs: root
shell: bash

env:
  # base64 encoded config file and private key are stored in vault
  vaultVariables:
    configFile : ocid1.vaultsecret.oc1.phx.amaaaaaab6fywtyalawzy7db736fyfx7hwbbsjziohzysb4r4dxamz3rzu7a
    ociCliApiPrivateKey : ocid1.vaultsecret.oc1.phx.amaaaaaab6fywtyatx6xth7ij2nd5ukza255dp3qdqextk6ca5aax7rdijia

steps:
  - type: Command
    name: "Setup oci cli with api key"
    timeoutInSeconds: 400
    runAs: ocarun
    command: |
      echo "harsh singh jadon"
      echo "ganpati bappa moriya"
      whoami
      pwd
      echo "Files in /workspace/Source:- "
      ls -l
      echo "Files in /workspace :-"
      ls -l ..
      echo "Files in root"
      ls -l /
      
      
      echo "Setup oci-cli directory to store oci private api key and config file."
      mkdir -p /workspace/oci-cli

      echo "Download oci private api key to the oci-cli directory."
      echo $ociCliApiPrivateKey | base64 --decode > /workspace/oci-cli/oci_api_key.pem
      
      echo "Run 1"
      echo $ociCliApiPrivateKey
      cat /workspace/oci-cli/oci_api_key.pem

      echo "Download oci config file to the oci-cli directory."
      echo $configFile | base64 --decode > /workspace/oci-cli/config
      
      echo "Run 2"
      echo $configFile
      cat /workspace/oci-cli/config
      
      sleep 10000
      
      echo "Configure oci cli to use api_key that was downloaded."
      export OCI_CLI_AUTH=api_key
      export OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING=True
      export OCI_CLI_CONFIG_FILE=/workspace/oci-cli/config
      echo $OCI_CLI_AUTH
      echo $OCI_CLI_CONFIG_FILE
      echo $OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING
      
      echo "Files in current directory"
      ls -l /workspace/oci-cli
      echo "OCI version is:- "
      oci --version
      echo "Java version is:- "
      java -version
      echo "Present working directory is:-"
      pwd

      echo "Testing the setup"
      oci os ns get
      echo "lets see!!"
